# 社区话题标签页功能

## 功能概述

参考 galgamex.net 的设计，实现了带有标签页的社区话题首页，包含四个标签页：

### 标签页说明
- **关注** - 显示你关注的用户发布的话题
- **全部** - 显示所有社区话题（默认）
- **官方** - 显示官方帮助文档（卡片式布局，类似 galgamex 的帮助文档页面）
- **图片** - 显示包含图片的话题

## 主要特性

1. **首页即话题列表** - 网站首页 `/` 直接显示社区话题
2. **双入口设计** - "首页"和"社区话题列表"都指向同一页面
3. **混合内容展示** - 官方标签页显示文档卡片，其他标签页显示话题列表
4. **响应式布局** - 文档使用瀑布流布局，话题使用网格布局

## 修改的文件

### 1. `app/(main)/page.tsx` ⭐ 首页
- 将原来的 `HomeContainer` 替换为 `TopicListPage`
- 网站首页现在直接显示社区话题列表
- 添加了 Suspense 和加载状态

### 2. `components/topic/TopicListPage.tsx` ⭐ 服务端组件
- 服务端组件，负责获取官方文档数据
- 使用 `getAllPosts()` 从文件系统读取 MDX 文档
- 将文档数据传递给客户端组件

### 3. `components/topic/TopicListClient.tsx` ⭐ 客户端组件
**新增功能：**
- 添加了 `Tabs` 组件实现四个标签页导航
- 集成了文档展示功能（官方标签页）
- 根据标签页类型动态切换内容展示方式
- 官方标签页使用 `KunMasonryGrid` 瀑布流布局展示文档卡片
- 其他标签页使用 `TopicList` 组件展示话题

**状态管理：**
- `activeTab`: 当前选中的标签页
- `topics`: 话题列表数据
- `officialDocs`: 官方文档数据（从 props 接收）

**条件渲染：**
- 官方标签页：隐藏"发布话题"按钮、筛选排序、分页
- 其他标签页：显示完整的话题列表功能

### 4. `app/api/topic/route.ts`
- 添加 `type` 查询参数支持
- 实现不同类型的过滤逻辑：
  - `following`: 通过 `user_follow_relation` 表查询关注用户的话题
  - `image`: 查询内容包含 `![` (Markdown 图片语法) 的话题
- 移除了 `official` 类型的后端过滤（官方内容改为前端展示文档）

### 5. `components/layout/Sidebar.tsx`
- 保留"首页"导航项（指向 `/`）
- 保留"社区话题列表"导航项（也指向 `/`）
- 两个入口都可以访问话题列表页面

### 6. `components/layout/RightSidebar.tsx` ⭐ 新增
右侧边栏组件，包含三个主要部分：

**游客提示卡片（未登录）：**
- 显示游客头像占位符
- "发布话题"按钮（点击跳转登录）
- "登录"按钮

**用户信息卡片（已登录）：**
- 显示用户头像和名称
- "发布话题"按钮（直接跳转创建页面）

**社区统计：**
- 话题数量
- 用户数量
- 评论数量
- 帖子数量

**热门板块：**
- 显示热门标签列表
- 每个标签显示话题数量
- 点击可跳转到对应标签页面

## 架构设计

### 服务端/客户端分离
为了解决 `fs` 模块在客户端无法使用的问题，采用了服务端/客户端组件分离的架构：

```
TopicListPage (Server Component)
  ↓ 获取文档数据 (getAllPosts)
  ↓ 传递 props
TopicListClient (Client Component)
  ↓ 处理交互和状态
  ↓ 根据标签页渲染不同内容
```

**优势：**
- 文档数据在服务端读取，避免客户端 fs 模块错误
- 客户端组件处理用户交互和状态管理
- 数据通过 props 传递，类型安全
- 符合 Next.js 13+ App Router 最佳实践

## 使用方式

访问网站首页即可看到话题列表，点击顶部的标签页切换不同的视图：

```
/                         # 首页 - 默认显示全部话题
/?tab=following           # 显示关注的话题
/?tab=official            # 显示官方文档
/?tab=image               # 显示图片话题
```

## 技术细节

### 标签页顺序
按照 galgamex.net 的顺序：关注 → 全部 → 官方 → 图片

### 数据来源
- **关注/全部/图片**: 从 API `/api/topic` 获取话题数据
- **官方**: 从 MDX 文件系统读取文档（`getAllPosts()`）

### 布局方式
- **官方文档**: 使用 `KunMasonryGrid` 瀑布流布局 + `KunAboutCard` 卡片组件
- **话题列表**: 使用 `TopicList` 组件，2列网格布局

### 数据库查询
- **关注**: 通过 `user_follow_relation` 表关联查询
  ```prisma
  where.user = {
    follower: {
      some: {
        follower_id: currentUserId
      }
    }
  }
  ```
- **图片**: 通过内容搜索 Markdown 图片语法
  ```prisma
  where.content = {
    contains: '!['
  }
  ```

### 权限控制
- 未登录用户访问"关注"标签页时，不会显示任何内容
- 建议后续添加登录提示引导

## 导航结构

**核心功能分类：**
- 首页 → `/` (社区话题)
- Galgame → `/galgame`
- 补丁和存档 → `/resource`

**社区交流分类：**
- 社区话题列表 → `/` (与首页相同)
- 评论动态 → `/comment`

## 视觉效果

参考 galgamex.net 的设计：
- 标签页使用下划线样式 (`variant="underlined"`)
- 官方文档使用卡片式布局，带有封面图、标题、日期、字数统计
- 瀑布流布局自适应不同高度的卡片
- 悬停效果：卡片轻微放大 (`hover:scale-[1.02]`)

## 后续优化建议

1. **未登录提示** - 为未登录用户访问"关注"标签页时显示登录引导
2. **图片标记字段** - 考虑在数据库添加 `has_image` 字段，避免内容搜索
3. **数量统计** - 在标签页上显示各类型的数量徽章
4. **更多过滤** - 支持热门、精华、最新等更多过滤维度
5. **搜索功能** - 在官方文档标签页添加文档搜索
6. **缓存优化** - 对文档列表进行缓存，提升加载速度
7. **骨架屏** - 添加更友好的加载状态展示
